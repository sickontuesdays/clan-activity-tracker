<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S!ck on Tuesdays! - Activity Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #ffffff;
            min-height: 100vh;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 280px 1fr 280px;
            gap: 20px;
        }

        .header {
            grid-column: 1 / -1;
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border: 1px solid #333;
        }

        .header h1 {
            color: #f7931e;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .header p {
            color: #cccccc;
            font-size: 1.1em;
        }

        .controls-section {
            grid-column: 1 / -1;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid #444;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .load-data-btn {
            background: linear-gradient(45deg, #f7931e, #e6840e);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .load-data-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(247, 147, 30, 0.4);
        }

        .load-data-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .search-container {
            flex: 1;
            min-width: 300px;
        }

        .search-label {
            color: #f7931e;
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }

        .search-select {
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #666;
            border-radius: 5px;
            color: #fff;
            font-size: 1em;
        }

        .search-select option {
            background: #1a1a2e;
            color: #fff;
        }

        .data-status {
            color: #aaa;
            font-size: 0.9em;
        }

        .sidebar {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid #444;
            border-radius: 10px;
            padding: 20px;
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .sidebar-title {
            color: #f7931e;
            font-size: 1.2em;
            margin-bottom: 15px;
            font-weight: bold;
            text-align: center;
        }

        .ranking-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .ranking-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ranking-item.inactive {
            opacity: 0.5;
            background: rgba(0, 0, 0, 0.2);
            border-color: #555;
        }

        .ranking-item.inactive .ranking-name {
            color: #888;
        }

        .ranking-position {
            color: #f7931e;
            font-weight: bold;
            min-width: 25px;
        }

        .ranking-name {
            flex: 1;
            margin: 0 10px;
            font-size: 0.9em;
        }

        .ranking-value {
            color: #aaa;
            font-size: 0.8em;
            font-weight: bold;
        }

        .no-data-message {
            text-align: center;
            color: #888;
            font-style: italic;
            font-size: 0.8em;
            margin-top: 10px;
        }

        .main-content {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid #444;
            border-radius: 10px;
            padding: 20px;
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            color: #f7931e;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            color: #aaa;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #f7931e;
        }

        .error {
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid #ff4444;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            color: #ff6666;
        }

        .activity-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border: 1px solid #333;
        }

        .activity-count {
            color: #aaa;
            font-size: 0.9em;
        }

        .load-more-btn {
            background: rgba(247, 147, 30, 0.2);
            border: 1px solid #f7931e;
            color: #f7931e;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .load-more-btn:hover:not(:disabled) {
            background: rgba(247, 147, 30, 0.3);
            transform: translateY(-1px);
        }

        .load-more-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .activity-list {
            display: grid;
            gap: 15px;
        }

        .activity-item {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .activity-item:hover {
            border-color: #f7931e;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(247, 147, 30, 0.3);
        }

        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .activity-info {
            flex: 1;
        }

        .activity-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #f7931e;
            margin-bottom: 5px;
        }

        .activity-mode {
            color: #888;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .activity-time {
            color: #aaa;
            font-size: 0.8em;
        }

        .activity-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
            white-space: nowrap;
        }

        .status-complete {
            background: rgba(0, 255, 0, 0.2);
            color: #00ff00;
            border: 1px solid #00ff00;
        }

        .status-incomplete {
            background: rgba(255, 255, 0, 0.2);
            color: #ffff00;
            border: 1px solid #ffff00;
        }

        .activity-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
        }

        .detail-label {
            color: #aaa;
        }

        .detail-value {
            color: #fff;
            font-weight: 500;
        }

        .fireteam {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #333;
        }

        .fireteam-title {
            color: #f7931e;
            font-size: 0.9em;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .fireteam-members {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .member-tag {
            background: rgba(247, 147, 30, 0.2);
            border: 1px solid #f7931e;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            color: #f7931e;
        }

        .clan-member {
            background: rgba(0, 255, 0, 0.2);
            border-color: #00ff00;
            color: #00ff00;
        }

        .stats-preview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #333;
        }

        .stat-item {
            text-align: center;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }

        .stat-value-small {
            display: block;
            font-size: 1.1em;
            font-weight: bold;
            color: #f7931e;
        }

        .stat-label-small {
            display: block;
            font-size: 0.8em;
            color: #aaa;
            margin-top: 2px;
        }

        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
            }
            
            .controls-section {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }
            
            .sidebar {
                position: static;
                margin-bottom: 20px;
            }
        }

        @media (max-width: 768px) {
            .activity-controls {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .activity-details {
                grid-template-columns: 1fr;
            }
            
            .stats-preview {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>S!ck on Tuesdays!</h1>
            <p>Clan Activity Tracker & Statistics</p>
        </div>

        <div class="controls-section">
            <button id="loadDataBtn" class="load-data-btn" onclick="loadRecentActivities()">
                Load Last 24 Hours
            </button>
            
            <div class="search-container">
                <label class="search-label">Search by Clan Member:</label>
                <select id="memberSelect" class="search-select" onchange="filterByMember()">
                    <option value="">All Members</option>
                </select>
            </div>
            
            <div class="data-status" id="dataStatus">
                No data loaded
            </div>
        </div>

        <div class="sidebar">
            <div class="sidebar-title">‚è±Ô∏è Most Time Played</div>
            <div class="ranking-list" id="timeRankings">
                <div style="text-align: center; color: #888; padding: 20px;">
                    Load data to see rankings
                </div>
            </div>
        </div>

        <div class="main-content">
            <div id="statsBar" class="stats-bar" style="display: none;">
                <div class="stat-card">
                    <span class="stat-value" id="totalActivities">0</span>
                    <span class="stat-label">Activities (24h)</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="activePlayers">0</span>
                    <span class="stat-label">Active Players</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="totalKills">0</span>
                    <span class="stat-label">Total Kills</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="avgKD">0.00</span>
                    <span class="stat-label">Average K/D</span>
                </div>
            </div>

            <div id="loading" class="loading" style="display: none;">
                Loading clan activities...
            </div>

            <div id="error" class="error" style="display: none;"></div>

            <div id="activityControls" class="activity-controls" style="display: none;">
                <div class="activity-count">
                    Showing <span id="shownCount">0</span> of <span id="totalCount">0</span> activities
                </div>
                <button id="loadMoreBtn" class="load-more-btn" onclick="loadMoreActivities()">Load More</button>
            </div>

            <div id="activities" class="activity-list" style="display: none;"></div>
        </div>

        <div class="sidebar">
            <div class="sidebar-title">üéØ Most Kills</div>
            <div class="ranking-list" id="killsRankings">
                <div style="text-align: center; color: #888; padding: 20px;">
                    Load data to see rankings
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            CLAN_NAME: 'S!ck on Tuesdays!',
            GROUP_TYPE: 1,
            ACTIVITIES_PER_PAGE: 10,
            HOURS_LOOKBACK: 24,
            FILTERED_MODES: [2, 3, 6] // Story, Strike, Patrol - activities to exclude
        };

        // Global variables
        let clanData = null;
        let clanMembers = [];
        let clanMemberIds = new Set();
        let allActivities = [];
        let filteredActivities = [];
        let displayedActivities = [];
        let currentPage = 0;
        let activityDefinitionCache = new Map();
        let cachedData = {
            activities: [],
            lastUpdated: 0,
            memberStats: new Map(),
            clanMembers: []
        };

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });

        async function initializePage() {
            // Try to load cached data first
            if (loadCache() && cachedData.activities.length > 0) {
                console.log('Loading from cache...');
                cleanOldActivities();
                
                // Restore cached clan data
                if (cachedData.clanMembers && cachedData.clanMembers.length > 0) {
                    clanMembers = cachedData.clanMembers;
                    clanMemberIds = new Set(clanMembers.map(member => member.destinyUserInfo.membershipId));
                    populateMemberSelect();
                }
                
                allActivities = cachedData.activities;
                filteredActivities = [...allActivities];
                displayedActivities = [];
                currentPage = 0;
                
                updateDataStatus(`Cached data: ${allActivities.length} activities`);
                showContent();
                updateStatsBar();
                updateRankings();
                loadMoreActivities();
                
                document.getElementById('loadDataBtn').textContent = 'Refresh Data';
            } else {
                // No cached data, try to get clan members for search dropdown
                try {
                    await loadClanMembersOnly();
                } catch (error) {
                    console.log('Could not pre-load clan members:', error.message);
                }
            }
        }

        async function loadClanMembersOnly() {
            try {
                updateDataStatus('Loading clan members...');
                
                if (!clanData) {
                    clanData = await getClanByName();
                    if (!clanData || !clanData.detail) {
                        throw new Error('Clan not found');
                    }
                }

                clanMembers = await getClanMembers(clanData.detail.groupId);
                if (clanMembers.length === 0) {
                    throw new Error('No clan members found');
                }

                // Get proper display names for each member
                updateDataStatus('Getting member display names...');
                clanMembers = await Promise.all(clanMembers.map(async (member) => {
                    try {
                        const membershipType = member.destinyUserInfo.membershipType;
                        const membershipId = member.destinyUserInfo.membershipId;
                        
                        const profileEndpoint = `/Destiny2/${membershipType}/Profile/${membershipId}/?components=Profiles`;
                        const profileData = await makeAPIRequest(profileEndpoint);
                        
                        // Get the proper display name
                        const properDisplayName = profileData?.profile?.data?.userInfo?.bungieGlobalDisplayName || 
                                                 profileData?.profile?.data?.userInfo?.displayName || 
                                                 member.destinyUserInfo.displayName;
                        
                        return {
                            ...member,
                            properDisplayName: properDisplayName
                        };
                    } catch (error) {
                        // If profile is private or fails, use original display name
                        return {
                            ...member,
                            properDisplayName: member.destinyUserInfo.displayName
                        };
                    }
                }));

                clanMemberIds = new Set(clanMembers.map(member => member.destinyUserInfo.membershipId));
                populateMemberSelect();
                
                // Cache clan members
                cachedData.clanMembers = clanMembers;
                saveCache();
                
                updateDataStatus('Clan members loaded - Click "Load Last 24 Hours" for activities');
            } catch (error) {
                console.error('Failed to load clan members:', error);
                updateDataStatus('Click "Load Last 24 Hours" to begin');
            }
        }

        // Cache management
        function getCacheKey() {
            return 'clan_activity_cache';
        }

        function saveCache() {
            try {
                const cacheData = {
                    ...cachedData,
                    memberStats: Array.from(cachedData.memberStats.entries())
                };
                localStorage.setItem(getCacheKey(), JSON.stringify(cacheData));
            } catch (error) {
                console.warn('Failed to save cache:', error);
            }
        }

        function loadCache() {
            try {
                const cached = localStorage.getItem(getCacheKey());
                if (cached) {
                    const parsedCache = JSON.parse(cached);
                    cachedData = {
                        ...parsedCache,
                        memberStats: new Map(parsedCache.memberStats || [])
                    };
                    return true;
                }
            } catch (error) {
                console.warn('Failed to load cache:', error);
            }
            return false;
        }

        function cleanOldActivities() {
            const cutoffTime = Date.now() - (CONFIG.HOURS_LOOKBACK * 60 * 60 * 1000);
            cachedData.activities = cachedData.activities.filter(activity => 
                new Date(activity.period).getTime() >= cutoffTime
            );
        }

        // Utility functions
        function showError(message) {
            document.getElementById('error').textContent = message;
            document.getElementById('error').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showContent() {
            document.getElementById('statsBar').style.display = 'grid';
            document.getElementById('activityControls').style.display = 'flex';
            document.getElementById('activities').style.display = 'block';
        }

        function updateDataStatus(message) {
            document.getElementById('dataStatus').textContent = message;
        }

        async function makeAPIRequest(endpoint) {
            try {
                const response = await fetch(`/api/bungie?endpoint=${encodeURIComponent(endpoint)}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error);
                }
                if (data.ErrorCode !== 1) {
                    throw new Error(`API Error: ${data.Message}`);
                }
                return data.Response;
            } catch (error) {
                console.error('API Request failed:', error);
                throw error;
            }
        }

        async function getClanByName() {
            try {
                const endpoint = `/GroupV2/Name/${encodeURIComponent(CONFIG.CLAN_NAME)}/${CONFIG.GROUP_TYPE}/`;
                const response = await makeAPIRequest(endpoint);
                return response;
            } catch (error) {
                throw new Error(`Failed to find clan: ${error.message}`);
            }
        }

        async function getClanMembers(groupId) {
            try {
                const endpoint = `/GroupV2/${groupId}/Members/`;
                const response = await makeAPIRequest(endpoint);
                return response.results || [];
            } catch (error) {
                throw new Error(`Failed to get clan members: ${error.message}`);
            }
        }

        async function getActivityHistory(membershipType, membershipId, characterId, count = 50) {
            try {
                const endpoint = `/Destiny2/${membershipType}/Account/${membershipId}/Character/${characterId}/Stats/Activities/?count=${count}&mode=0&page=0`;
                const response = await makeAPIRequest(endpoint);
                return response.activities || [];
            } catch (error) {
                if (error.message.includes('private') || error.message.includes('No peeking')) {
                    console.log(`Profile is private for character ${characterId}, skipping...`);
                    return [];
                }
                console.error(`Failed to get activities for character ${characterId}:`, error);
                return [];
            }
        }

        async function getPGCR(instanceId) {
            try {
                const endpoint = `/Destiny2/Stats/PostGameCarnageReport/${instanceId}/`;
                const response = await makeAPIRequest(endpoint);
                return response;
            } catch (error) {
                console.warn(`Failed to get PGCR for ${instanceId}:`, error);
                return null;
            }
        }

        function isValidActivity(activity) {
            // Filter out strikes, patrols, story missions
            return !CONFIG.FILTERED_MODES.includes(activity.activityDetails.mode);
        }

        function isWithinLast24Hours(dateString) {
            const activityDate = new Date(dateString);
            const now = new Date();
            const twentyFourHoursAgo = new Date(now - (CONFIG.HOURS_LOOKBACK * 60 * 60 * 1000));
            return activityDate >= twentyFourHoursAgo;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMinutes = Math.floor(diffMs / (1000 * 60));

            if (diffHours < 1) {
                return `${diffMinutes}m ago`;
            } else if (diffHours < 24) {
                return `${diffHours}h ago`;
            } else {
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }
        }

        function getActivityModeString(mode) {
            const modes = {
                0: 'All', 4: 'Raid', 5: 'PvP', 7: 'PvE', 10: 'Control', 12: 'Clash', 
                15: 'Crimson Doubles', 16: 'Nightfall', 18: 'Iron Banner', 19: 'Trials', 
                25: 'Mayhem', 31: 'Supremacy', 32: 'Private Match', 37: 'Survival',
                38: 'Countdown', 39: 'Trials of the Nine', 40: 'Social', 41: 'Trials Countdown',
                42: 'Trials Survival', 43: 'Iron Banner Control', 44: 'Iron Banner Clash',
                45: 'Iron Banner Supremacy', 46: 'Scored Nightfall', 47: 'Scored Heroic Nightfall',
                48: 'Rumble', 49: 'Doubles', 50: 'Doubles Clash', 51: 'Breakthrough',
                52: 'Black Armory Run', 53: 'Salvage', 54: 'Iron Banner Salvage', 55: 'PvP Competitive',
                56: 'PvP Quickplay', 57: 'Clash Quickplay', 58: 'Clash Competitive', 59: 'Control Quickplay',
                60: 'Control Competitive', 61: 'Gambit Prime', 62: 'Reckoning', 63: 'Menagerie',
                64: 'VexOffensive', 65: 'NightmareHunt', 66: 'Elimination', 67: 'Momentum',
                68: 'Dungeon', 69: 'Sundial', 70: 'TrialsOfOsiris', 71: 'Dares', 72: 'Offensive',
                73: 'LostSector', 74: 'Rift', 75: 'ZoneControl', 76: 'IronBannerRift', 77: 'IronBannerZoneControl',
                78: 'Crucible', 79: 'Checkmate', 80: 'IronBannerCheckmate', 81: 'Exotic', 82: 'Battleground',
                83: 'PsiOps', 84: 'WellspringAttack', 85: 'WellspringDefend', 86: 'PsiOpsBattleground'
            };
            return modes[mode] || `Mode ${mode}`;
        }

        async function getActivityDefinition(activityHash) {
            if (activityDefinitionCache.has(activityHash)) {
                return activityDefinitionCache.get(activityHash);
            }

            try {
                const endpoint = `/Destiny2/Manifest/DestinyActivityDefinition/${activityHash}/`;
                const response = await makeAPIRequest(endpoint);
                activityDefinitionCache.set(activityHash, response);
                return response;
            } catch (error) {
                console.error(`Failed to get activity definition for ${activityHash}:`, error);
                return null;
            }
        }

        async function collectRecentActivities() {
            const allRecentActivities = [];
            const activityPromises = [];
            const memberStats = new Map();

            // Initialize stats for ALL clan members using proper display names
            for (const member of clanMembers) {
                const membershipId = member.destinyUserInfo.membershipId;
                const displayName = member.properDisplayName || member.destinyUserInfo.displayName;
                
                memberStats.set(membershipId, {
                    displayName: displayName,
                    properDisplayName: member.properDisplayName || displayName,
                    totalTimePlayed: 0,
                    totalKills: 0,
                    activities: [],
                    hasData: false
                });
            }

            for (const member of clanMembers) {
                const membershipType = member.destinyUserInfo.membershipType;
                const membershipId = member.destinyUserInfo.membershipId;
                const displayName = member.properDisplayName || member.destinyUserInfo.displayName;
                
                try {
                    const profileEndpoint = `/Destiny2/${membershipType}/Profile/${membershipId}/?components=200`;
                    const profile = await makeAPIRequest(profileEndpoint);
                    
                    if (profile && profile.characters && profile.characters.data) {
                        const characters = Object.keys(profile.characters.data);
                        
                        for (const characterId of characters.slice(0, 3)) {
                            activityPromises.push(
                                getActivityHistory(membershipType, membershipId, characterId, 25)
                                    .then(activities => 
                                        activities
                                            .filter(activity => isWithinLast24Hours(activity.period) && isValidActivity(activity))
                                            .map(activity => {
                                                return {
                                                    ...activity,
                                                    memberInfo: {
                                                        displayName: displayName,
                                                        properDisplayName: member.properDisplayName || displayName,
                                                        membershipType: membershipType,
                                                        membershipId: membershipId,
                                                        characterId: characterId
                                                    }
                                                };
                                            })
                                    )
                            );
                        }
                    }
                } catch (error) {
                    if (error.message.includes('private') || error.message.includes('No peeking')) {
                        console.log(`Profile is private for member ${displayName}, skipping...`);
                    } else {
                        console.error(`Error getting profile for member ${displayName}:`, error);
                    }
                }
            }

            const activityResults = await Promise.allSettled(activityPromises);
            
            activityResults.forEach(result => {
                if (result.status === 'fulfilled' && result.value) {
                    allRecentActivities.push(...result.value);
                }
            });

            // Get PGCR data for each activity to get accurate statistics
            const activitiesWithPGCR = await Promise.all(
                allRecentActivities.map(async (activity) => {
                    const pgcr = await getPGCR(activity.activityDetails.instanceId);
                    
                    // Find the clan member in the PGCR data
                    let clanMemberEntry = null;
                    if (pgcr && pgcr.entries) {
                        clanMemberEntry = pgcr.entries.find(entry => 
                            entry.player.destinyUserInfo.membershipId === activity.memberInfo.membershipId
                        );
                    }
                    
                    // Track member stats using PGCR data if available
                    const stats = memberStats.get(activity.memberInfo.membershipId);
                    if (clanMemberEntry && clanMemberEntry.values) {
                        // Combine stats from both locations
                        const combinedStats = { ...clanMemberEntry.values };
                        if (clanMemberEntry.extended && clanMemberEntry.extended.values) {
                            Object.keys(clanMemberEntry.extended.values).forEach(key => {
                                combinedStats[key] = clanMemberEntry.extended.values[key];
                            });
                        }
                        
                        stats.totalTimePlayed += combinedStats.activityDurationSeconds?.basic?.value || 0;
                        stats.totalKills += combinedStats.kills?.basic?.value || 0;
                        stats.hasData = true;
                    }
                    stats.activities.push(activity);

                    return {
                        ...activity,
                        pgcrData: pgcr,
                        clanMemberEntry: clanMemberEntry
                    };
                })
            );

            // Remove duplicates and sort
            const uniqueActivities = activitiesWithPGCR.reduce((acc, activity) => {
                const key = activity.activityDetails.instanceId;
                if (!acc.has(key)) {
                    acc.set(key, activity);
                }
                return acc;
            }, new Map());

            const sortedActivities = Array.from(uniqueActivities.values())
                .sort((a, b) => new Date(b.period) - new Date(a.period));
            
            // Update cache
            cachedData.activities = sortedActivities;
            cachedData.memberStats = memberStats;
            cachedData.clanMembers = clanMembers;
            cachedData.lastUpdated = Date.now();
            saveCache();
            
            console.log(`Collected ${sortedActivities.length} activities from ${clanMembers.length} clan members`);
            return sortedActivities;
        }

        function populateMemberSelect() {
            const select = document.getElementById('memberSelect');
            select.innerHTML = '<option value="">All Members</option>';
            
            const sortedMembers = [...clanMembers].sort((a, b) => 
                (a.properDisplayName || a.destinyUserInfo.displayName).localeCompare(b.properDisplayName || b.destinyUserInfo.displayName)
            );
            
            sortedMembers.forEach(member => {
                const option = document.createElement('option');
                option.value = member.destinyUserInfo.membershipId;
                option.textContent = member.properDisplayName || member.destinyUserInfo.displayName;
                select.appendChild(option);
            });
        }

        function filterByMember() {
            const select = document.getElementById('memberSelect');
            const selectedMemberId = select.value;
            
            if (selectedMemberId) {
                filteredActivities = allActivities.filter(activity => 
                    activity.memberInfo.membershipId === selectedMemberId
                );
            } else {
                filteredActivities = [...allActivities];
            }
            
            // Reset pagination
            displayedActivities = [];
            currentPage = 0;
            
            updateStatsBar();
            updateRankings();
            loadMoreActivities();
        }

        function updateStatsBar() {
            const activities = filteredActivities;
            const totalActivities = activities.length;
            const activePlayers = new Set(activities.map(a => a.memberInfo.membershipId)).size;
            
            let totalKills = 0;
            let totalDeaths = 0;
            
            // Use PGCR data for accurate statistics
            activities.forEach(activity => {
                if (activity.clanMemberEntry && activity.clanMemberEntry.values) {
                    const stats = activity.clanMemberEntry.values;
                    const extendedStats = activity.clanMemberEntry.extended?.values || {};
                    
                    totalKills += stats.kills?.basic?.value || 0;
                    totalDeaths += stats.deaths?.basic?.value || 0;
                }
            });

            const avgKD = totalDeaths > 0 ? (totalKills / totalDeaths).toFixed(2) : totalKills.toFixed(2);

            document.getElementById('totalActivities').textContent = totalActivities;
            document.getElementById('activePlayers').textContent = activePlayers;
            document.getElementById('totalKills').textContent = totalKills.toLocaleString();
            document.getElementById('avgKD').textContent = avgKD;
        }

        function updateRankings() {
            const timeRankings = document.getElementById('timeRankings');
            const killsRankings = document.getElementById('killsRankings');
            
            if (cachedData.memberStats.size === 0) {
                timeRankings.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">No data available</div>';
                killsRankings.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">No data available</div>';
                return;
            }

            // Time played rankings - include ALL members
            const allMembers = Array.from(cachedData.memberStats.values());
            const timeRanked = allMembers
                .sort((a, b) => b.totalTimePlayed - a.totalTimePlayed)
                .slice(0, 15);

            timeRankings.innerHTML = timeRanked.map((stats, index) => {
                const hours = Math.floor(stats.totalTimePlayed / 3600);
                const minutes = Math.floor((stats.totalTimePlayed % 3600) / 60);
                const timeText = stats.hasData ? `${hours}h ${minutes}m` : 'No data (24h)';
                const isActive = stats.hasData;
                const displayName = stats.properDisplayName || stats.displayName;
                
                return `
                    <div class="ranking-item ${!isActive ? 'inactive' : ''}">
                        <div class="ranking-position">${index + 1}</div>
                        <div class="ranking-name">${displayName}</div>
                        <div class="ranking-value">${timeText}</div>
                    </div>
                `;
            }).join('');

            // Kills rankings - include ALL members
            const killsRanked = allMembers
                .sort((a, b) => b.totalKills - a.totalKills)
                .slice(0, 15);

            killsRankings.innerHTML = killsRanked.map((stats, index) => {
                const killsText = stats.hasData ? stats.totalKills.toString() : 'No data (24h)';
                const isActive = stats.hasData;
                const displayName = stats.properDisplayName || stats.displayName;
                
                return `
                    <div class="ranking-item ${!isActive ? 'inactive' : ''}">
                        <div class="ranking-position">${index + 1}</div>
                        <div class="ranking-name">${displayName}</div>
                        <div class="ranking-value">${killsText}</div>
                    </div>
                `;
            }).join('');

            // Add no data message if needed
            if (allMembers.filter(m => m.hasData).length === 0) {
                const noDataMsg = '<div class="no-data-message">Players with no activity data in last 24 hours have been greyed out.</div>';
                timeRankings.innerHTML += noDataMsg;
                killsRankings.innerHTML += noDataMsg;
            }
        }

        function updateActivityControls() {
            const totalCount = filteredActivities.length;
            const shownCount = displayedActivities.length;
            
            document.getElementById('totalCount').textContent = totalCount;
            document.getElementById('shownCount').textContent = shownCount;
            
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            loadMoreBtn.disabled = shownCount >= totalCount;
            loadMoreBtn.textContent = shownCount >= totalCount ? 'All Activities Loaded' : 'Load More';
        }

        async function renderActivities(activities) {
            const container = document.getElementById('activities');
            
            if (activities.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888; padding: 40px;">No activities found.</p>';
                return;
            }

            // Get activity definitions
            const activityHashes = [...new Set(activities.map(a => a.activityDetails.directorActivityHash).filter(h => h))];
            
            const definitionPromises = activityHashes.map(async (hash) => {
                if (activityDefinitionCache.has(hash)) {
                    return { hash, definition: activityDefinitionCache.get(hash) };
                }
                const definition = await getActivityDefinition(hash);
                if (definition) {
                    activityDefinitionCache.set(hash, definition);
                }
                return { hash, definition };
            });

            await Promise.allSettled(definitionPromises);

            const activityHTML = activities.map((activity) => {
                const activityHash = activity.activityDetails.directorActivityHash;
                const definition = activityHash ? activityDefinitionCache.get(activityHash) : null;
                const activityName = definition?.displayProperties?.name || getActivityModeString(activity.activityDetails.mode);
                const activityType = getActivityModeString(activity.activityDetails.mode);
                
                // Use PGCR data for statistics if available, otherwise fall back to activity history data
                let statsSource = activity.values || {};
                let duration = null;
                let isComplete = true;
                
                if (activity.clanMemberEntry && activity.clanMemberEntry.values) {
                    statsSource = activity.clanMemberEntry.values;
                    // Combine with extended stats
                    if (activity.clanMemberEntry.extended && activity.clanMemberEntry.extended.values) {
                        Object.keys(activity.clanMemberEntry.extended.values).forEach(key => {
                            statsSource[key] = activity.clanMemberEntry.extended.values[key];
                        });
                    }
                    isComplete = statsSource.completionReason?.basic?.value === 0;
                } else if (activity.values) {
                    // Fallback to activity history data
                    isComplete = activity.values.completionReason?.basic?.value === 0;
                }
                
                // Check if this is a raid
                const isRaidActivity = activity.activityDetails.mode === 4;
                
                // Build fireteam section with PGCR data
                let fireteamHTML = '';
                if (activity.pgcrData && activity.pgcrData.entries) {
                    const fireteamMembers = activity.pgcrData.entries.map(entry => {
                        let playerName = entry.player.destinyUserInfo.displayName;
                        const isClanMember = clanMemberIds.has(entry.player.destinyUserInfo.membershipId);
                        
                        // If this is a clan member, use their proper display name
                        if (isClanMember) {
                            const clanMember = clanMembers.find(m => m.destinyUserInfo.membershipId === entry.player.destinyUserInfo.membershipId);
                            if (clanMember && clanMember.properDisplayName) {
                                playerName = clanMember.properDisplayName;
                            }
                        }
                        
                        return `<span class="member-tag ${isClanMember ? 'clan-member' : ''}">${playerName}</span>`;
                    });
                    
                    fireteamHTML = `
                        <div class="fireteam">
                            <div class="fireteam-title">Fireteam (${activity.pgcrData.entries.length})</div>
                            <div class="fireteam-members">
                                ${fireteamMembers.join('')}
                            </div>
                        </div>
                    `;
                }
                
                return `
                    <div class="activity-item" onclick="openActivityDetails('${activity.activityDetails.instanceId}')">
                        <div class="activity-header">
                            <div class="activity-info">
                                <div class="activity-name">${activityName}</div>
                                <div class="activity-mode">${activityType}</div>
                                <div class="activity-time">${formatDate(activity.period)}</div>
                            </div>
                            <div class="activity-status ${isComplete ? 'status-complete' : 'status-incomplete'}">
                                ${isComplete ? 'Complete' : 'Incomplete'}
                            </div>
                        </div>
                        
                        <div class="activity-details">
                            <div class="detail-item">
                                <span class="detail-label">Duration:</span>
                                <span class="detail-value">${statsSource?.activityDurationSeconds ? Math.floor(statsSource.activityDurationSeconds.basic.value / 60) + 'm' : 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Player:</span>
                                <span class="detail-value">${activity.memberInfo.properDisplayName || activity.memberInfo.displayName}</span>
                            </div>
                        </div>
                        
                        ${statsSource && Object.keys(statsSource).length > 0 ? `
                        <div class="stats-preview">
                            ${statsSource.kills ? `
                            <div class="stat-item">
                                <span class="stat-value-small">${statsSource.kills.basic.value}</span>
                                <span class="stat-label-small">Kills</span>
                            </div>
                            ` : ''}
                            ${statsSource.deaths ? `
                            <div class="stat-item">
                                <span class="stat-value-small">${statsSource.deaths.basic.value}</span>
                                <span class="stat-label-small">Deaths</span>
                            </div>
                            ` : ''}
                            ${statsSource.assists ? `
                            <div class="stat-item">
                                <span class="stat-value-small">${statsSource.assists.basic.value}</span>
                                <span class="stat-label-small">Assists</span>
                            </div>
                            ` : ''}
                            ${statsSource.score ? `
                            <div class="stat-item">
                                <span class="stat-value-small">${isRaidActivity ? 'N/A' : statsSource.score.basic.value.toLocaleString()}</span>
                                <span class="stat-label-small">Score</span>
                            </div>
                            ` : ''}
                        </div>
                        ` : ''}
                        
                        ${fireteamHTML}
                    </div>
                `;
            }).join('');

            container.innerHTML = activityHTML;
        }

        function loadMoreActivities() {
            const startIndex = currentPage * CONFIG.ACTIVITIES_PER_PAGE;
            const endIndex = startIndex + CONFIG.ACTIVITIES_PER_PAGE;
            const newActivities = filteredActivities.slice(startIndex, endIndex);
            
            displayedActivities = [...displayedActivities, ...newActivities];
            currentPage++;
            
            renderActivities(displayedActivities);
            updateActivityControls();
        }

        function openActivityDetails(instanceId) {
            const url = `activity-details.html?instanceId=${instanceId}`;
            window.location.href = url;
        }

        async function loadRecentActivities() {
            const loadBtn = document.getElementById('loadDataBtn');
            loadBtn.disabled = true;
            loadBtn.textContent = 'Loading...';
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';

            try {
                if (!clanData) {
                    updateDataStatus('Getting clan information...');
                    clanData = await getClanByName();
                    
                    if (!clanData || !clanData.detail) {
                        throw new Error('Clan not found');
                    }

                    updateDataStatus('Getting clan members...');
                    clanMembers = await getClanMembers(clanData.detail.groupId);
                    
                    if (clanMembers.length === 0) {
                        throw new Error('No clan members found');
                    }

                    // Get proper display names for each member
                    updateDataStatus('Getting member display names...');
                    clanMembers = await Promise.all(clanMembers.map(async (member) => {
                        try {
                            const membershipType = member.destinyUserInfo.membershipType;
                            const membershipId = member.destinyUserInfo.membershipId;
                            
                            const profileEndpoint = `/Destiny2/${membershipType}/Profile/${membershipId}/?components=Profiles`;
                            const profileData = await makeAPIRequest(profileEndpoint);
                            
                            // Get the proper display name
                            const properDisplayName = profileData?.profile?.data?.userInfo?.bungieGlobalDisplayName || 
                                                     profileData?.profile?.data?.userInfo?.displayName || 
                                                     member.destinyUserInfo.displayName;
                            
                            return {
                                ...member,
                                properDisplayName: properDisplayName
                            };
                        } catch (error) {
                            // If profile is private or fails, use original display name
                            return {
                                ...member,
                                properDisplayName: member.destinyUserInfo.displayName
                            };
                        }
                    }));

                    clanMemberIds = new Set(clanMembers.map(member => member.destinyUserInfo.membershipId));
                    populateMemberSelect();
                }

                updateDataStatus('Collecting activities...');
                
                // Load cache first
                loadCache();
                cleanOldActivities();
                
                // Collect new activities
                allActivities = await collectRecentActivities();
                filteredActivities = [...allActivities];
                
                // Reset pagination
                displayedActivities = [];
                currentPage = 0;
                
                updateDataStatus(`Loaded ${allActivities.length} activities (${new Date().toLocaleTimeString()})`);
                
                hideLoading();
                showContent();
                
                updateStatsBar();
                updateRankings();
                loadMoreActivities();

            } catch (error) {
                console.error('Load failed:', error);
                showError(`Failed to load clan data: ${error.message}`);
                updateDataStatus('Load failed');
            } finally {
                loadBtn.disabled = false;
                loadBtn.textContent = 'Refresh Data';
            }
        }
    </script>
</body>
</html>