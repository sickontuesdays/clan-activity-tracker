<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S!ck on Tuesdays! - Activity Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #ffffff;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border: 1px solid #333;
        }

        .header h1 {
            color: #f7931e;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .header p {
            color: #cccccc;
            font-size: 1.1em;
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            color: #f7931e;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            color: #aaa;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #f7931e;
        }

        .error {
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid #ff4444;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            color: #ff6666;
        }

        .activity-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border: 1px solid #333;
        }

        .activity-count {
            color: #aaa;
            font-size: 0.9em;
        }

        .load-more-btn {
            background: rgba(247, 147, 30, 0.2);
            border: 1px solid #f7931e;
            color: #f7931e;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .load-more-btn:hover:not(:disabled) {
            background: rgba(247, 147, 30, 0.3);
            transform: translateY(-1px);
        }

        .load-more-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .activity-list {
            display: grid;
            gap: 15px;
        }

        .activity-item {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .activity-item:hover {
            border-color: #f7931e;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(247, 147, 30, 0.3);
        }

        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .activity-info {
            flex: 1;
        }

        .activity-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #f7931e;
            margin-bottom: 5px;
        }

        .activity-mode {
            color: #888;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .activity-time {
            color: #aaa;
            font-size: 0.8em;
        }

        .activity-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
            white-space: nowrap;
        }

        .status-complete {
            background: rgba(0, 255, 0, 0.2);
            color: #00ff00;
            border: 1px solid #00ff00;
        }

        .status-incomplete {
            background: rgba(255, 255, 0, 0.2);
            color: #ffff00;
            border: 1px solid #ffff00;
        }

        .activity-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
        }

        .detail-label {
            color: #aaa;
        }

        .detail-value {
            color: #fff;
            font-weight: 500;
        }

        .fireteam {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #333;
        }

        .fireteam-title {
            color: #f7931e;
            font-size: 0.9em;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .fireteam-members {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .member-tag {
            background: rgba(247, 147, 30, 0.2);
            border: 1px solid #f7931e;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            color: #f7931e;
        }

        .clan-member {
            background: rgba(0, 255, 0, 0.2);
            border-color: #00ff00;
            color: #00ff00;
        }

        .stats-preview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #333;
        }

        .stat-item {
            text-align: center;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }

        .stat-value-small {
            display: block;
            font-size: 1.1em;
            font-weight: bold;
            color: #f7931e;
        }

        .stat-label-small {
            display: block;
            font-size: 0.8em;
            color: #aaa;
            margin-top: 2px;
        }

        @media (max-width: 768px) {
            .activity-controls {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .activity-details {
                grid-template-columns: 1fr;
            }
            
            .stats-preview {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>S!ck on Tuesdays!</h1>
            <p>Clan Activity Tracker & Statistics</p>
        </div>

        <div id="statsBar" class="stats-bar" style="display: none;">
            <div class="stat-card">
                <span class="stat-value" id="totalActivities">0</span>
                <span class="stat-label">Activities (24h)</span>
            </div>
            <div class="stat-card">
                <span class="stat-value" id="activePlayers">0</span>
                <span class="stat-label">Active Players</span>
            </div>
            <div class="stat-card">
                <span class="stat-value" id="totalKills">0</span>
                <span class="stat-label">Total Kills</span>
            </div>
            <div class="stat-card">
                <span class="stat-value" id="avgKD">0.00</span>
                <span class="stat-label">Average K/D</span>
            </div>
        </div>

        <div id="loading" class="loading">
            Loading clan activities...
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="activityControls" class="activity-controls" style="display: none;">
            <div class="activity-count">
                Showing <span id="shownCount">0</span> of <span id="totalCount">0</span> activities
            </div>
            <button id="loadMoreBtn" class="load-more-btn">Load More</button>
        </div>

        <div id="activities" class="activity-list" style="display: none;"></div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            CLAN_NAME: 'S!ck on Tuesdays!',
            GROUP_TYPE: 1,
            ACTIVITIES_PER_PAGE: 10,
            HOURS_LOOKBACK: 24
        };

        // Global variables
        let clanData = null;
        let clanMembers = [];
        let clanMemberIds = new Set();
        let allActivities = [];
        let displayedActivities = [];
        let currentPage = 0;

        // Utility functions
        function showError(message) {
            document.getElementById('error').textContent = message;
            document.getElementById('error').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showContent() {
            document.getElementById('statsBar').style.display = 'grid';
            document.getElementById('activityControls').style.display = 'flex';
            document.getElementById('activities').style.display = 'block';
        }

        async function makeAPIRequest(endpoint) {
            try {
                console.log('Making API request to:', `/api/bungie?endpoint=${encodeURIComponent(endpoint)}`);
                const response = await fetch(`/api/bungie?endpoint=${encodeURIComponent(endpoint)}`);
                
                console.log('Response status:', response.status);
                console.log('Response headers:', [...response.headers.entries()]);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Response error text:', errorText);
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                console.log('API Response:', data);
                
                if (data.error) {
                    throw new Error(data.error);
                }

                if (data.ErrorCode !== 1) {
                    throw new Error(`API Error: ${data.Message}`);
                }

                return data.Response;
            } catch (error) {
                console.error('API Request failed:', error);
                throw error;
            }
        }

        async function getClanByName() {
            try {
                const endpoint = `/GroupV2/Name/${encodeURIComponent(CONFIG.CLAN_NAME)}/${CONFIG.GROUP_TYPE}/`;
                const response = await makeAPIRequest(endpoint);
                return response;
            } catch (error) {
                throw new Error(`Failed to find clan: ${error.message}`);
            }
        }

        async function getClanMembers(groupId) {
            try {
                const endpoint = `/GroupV2/${groupId}/Members/`;
                const response = await makeAPIRequest(endpoint);
                return response.results || [];
            } catch (error) {
                throw new Error(`Failed to get clan members: ${error.message}`);
            }
        }

        async function getActivityHistory(membershipType, membershipId, characterId, count = 50) {
            try {
                const endpoint = `/Destiny2/${membershipType}/Account/${membershipId}/Character/${characterId}/Stats/Activities/?count=${count}&mode=0&page=0`;
                const response = await makeAPIRequest(endpoint);
                return response.activities || [];
            } catch (error) {
                // Handle common privacy errors gracefully
                if (error.message.includes('private') || error.message.includes('No peeking')) {
                    console.log(`Profile is private for character ${characterId}, skipping...`);
                    return [];
                }
                console.error(`Failed to get activities for character ${characterId}:`, error);
                return [];
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMinutes = Math.floor(diffMs / (1000 * 60));

            if (diffHours < 1) {
                return `${diffMinutes}m ago`;
            } else if (diffHours < 24) {
                return `${diffHours}h ago`;
            } else {
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }
        }

        function getActivityModeString(mode) {
            const modes = {
                0: 'All', 2: 'Story', 3: 'Strike', 4: 'Raid', 5: 'PvP', 6: 'Patrol', 7: 'PvE',
                10: 'Control', 12: 'Clash', 15: 'Crimson Doubles', 16: 'Nightfall', 18: 'Iron Banner',
                19: 'Trials', 25: 'Mayhem', 31: 'Supremacy', 32: 'Private Match', 37: 'Survival',
                38: 'Countdown', 39: 'Trials of the Nine', 40: 'Social', 41: 'Trials Countdown',
                42: 'Trials Survival', 43: 'Iron Banner Control', 44: 'Iron Banner Clash',
                45: 'Iron Banner Supremacy', 46: 'Scored Nightfall', 47: 'Scored Heroic Nightfall',
                48: 'Rumble', 49: 'Doubles', 50: 'Doubles Clash', 51: 'Breakthrough',
                52: 'Black Armory Run', 53: 'Salvage', 54: 'Iron Banner Salvage', 55: 'PvP Competitive',
                56: 'PvP Quickplay', 57: 'Clash Quickplay', 58: 'Clash Competitive', 59: 'Control Quickplay',
                60: 'Control Competitive', 61: 'Gambit Prime', 62: 'Reckoning', 63: 'Menagerie',
                64: 'VexOffensive', 65: 'NightmareHunt', 66: 'Elimination', 67: 'Momentum',
                68: 'Dungeon', 69: 'Sundial', 70: 'TrialsOfOsiris'
            };
            return modes[mode] || `Mode ${mode}`;
        }

        function isWithinLast24Hours(dateString) {
            const activityDate = new Date(dateString);
            const now = new Date();
            const twentyFourHoursAgo = new Date(now - (CONFIG.HOURS_LOOKBACK * 60 * 60 * 1000));
            return activityDate >= twentyFourHoursAgo;
        }

        async function getActivityDetails(instanceId) {
            try {
                const endpoint = `/Destiny2/Stats/PostGameCarnageReport/${instanceId}/`;
                const response = await makeAPIRequest(endpoint);
                return response;
            } catch (error) {
                console.error(`Failed to get activity details for ${instanceId}:`, error);
                return null;
            }
        }

        function updateStatsBar() {
            const totalActivities = allActivities.length;
            const activePlayers = new Set(allActivities.map(a => a.memberInfo.membershipId)).size;
            
            let totalKills = 0;
            let totalDeaths = 0;
            
            allActivities.forEach(activity => {
                if (activity.values) {
                    totalKills += activity.values.kills ? activity.values.kills.basic.value : 0;
                    totalDeaths += activity.values.deaths ? activity.values.deaths.basic.value : 0;
                }
            });

            const avgKD = totalDeaths > 0 ? (totalKills / totalDeaths).toFixed(2) : totalKills.toFixed(2);

            document.getElementById('totalActivities').textContent = totalActivities;
            document.getElementById('activePlayers').textContent = activePlayers;
            document.getElementById('totalKills').textContent = totalKills.toLocaleString();
            document.getElementById('avgKD').textContent = avgKD;
        }

        function updateActivityControls() {
            const totalCount = allActivities.length;
            const shownCount = displayedActivities.length;
            
            document.getElementById('totalCount').textContent = totalCount;
            document.getElementById('shownCount').textContent = shownCount;
            
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            loadMoreBtn.disabled = shownCount >= totalCount;
            loadMoreBtn.textContent = shownCount >= totalCount ? 'All Activities Loaded' : 'Load More';
        }

        async function renderActivities(activities) {
            const container = document.getElementById('activities');
            
            if (activities.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888; padding: 40px;">No recent activities found.</p>';
                return;
            }

            const activityDetailsPromises = activities.map(async (activity) => {
                const pgcr = await getActivityDetails(activity.activityDetails.instanceId);
                return { activity, pgcr };
            });

            const activityDetails = await Promise.allSettled(activityDetailsPromises);

            const activityHTML = activityDetails.map((result, index) => {
                if (result.status === 'rejected') return '';
                
                const { activity, pgcr } = result.value;
                const isComplete = activity.values && activity.values.completionReason && activity.values.completionReason.basic.value === 0;
                
                let fireteamMembers = [activity.memberInfo.displayName];
                let clanMembersInFireteam = clanMemberIds.has(activity.memberInfo.membershipId) ? 1 : 0;
                
                if (pgcr && pgcr.entries) {
                    fireteamMembers = pgcr.entries.map(entry => ({
                        name: entry.player.destinyUserInfo.displayName,
                        isClanMember: clanMemberIds.has(entry.player.destinyUserInfo.membershipId)
                    }));
                    clanMembersInFireteam = fireteamMembers.filter(m => m.isClanMember).length;
                }
                
                return `
                    <div class="activity-item" onclick="openActivityDetails('${activity.activityDetails.instanceId}')">
                        <div class="activity-header">
                            <div class="activity-info">
                                <div class="activity-name">
                                    ${activity.activityDetails.directorActivityHash ? 'Loading...' : 'Unknown Activity'}
                                </div>
                                <div class="activity-mode">
                                    ${getActivityModeString(activity.activityDetails.mode)}
                                </div>
                                <div class="activity-time">
                                    ${formatDate(activity.period)}
                                </div>
                            </div>
                            <div class="activity-status ${isComplete ? 'status-complete' : 'status-incomplete'}">
                                ${isComplete ? 'Complete' : 'Incomplete'}
                            </div>
                        </div>
                        
                        <div class="activity-details">
                            <div class="detail-item">
                                <span class="detail-label">Duration:</span>
                                <span class="detail-value">${activity.values?.activityDurationSeconds ? Math.floor(activity.values.activityDurationSeconds.basic.value / 60) + 'm' : 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Clan Members:</span>
                                <span class="detail-value">${clanMembersInFireteam}/${fireteamMembers.length}</span>
                            </div>
                        </div>
                        
                        ${activity.values ? `
                        <div class="stats-preview">
                            ${activity.values.kills ? `
                            <div class="stat-item">
                                <span class="stat-value-small">${activity.values.kills.basic.value}</span>
                                <span class="stat-label-small">Kills</span>
                            </div>
                            ` : ''}
                            ${activity.values.deaths ? `
                            <div class="stat-item">
                                <span class="stat-value-small">${activity.values.deaths.basic.value}</span>
                                <span class="stat-label-small">Deaths</span>
                            </div>
                            ` : ''}
                            ${activity.values.assists ? `
                            <div class="stat-item">
                                <span class="stat-value-small">${activity.values.assists.basic.value}</span>
                                <span class="stat-label-small">Assists</span>
                            </div>
                            ` : ''}
                            ${activity.values.score ? `
                            <div class="stat-item">
                                <span class="stat-value-small">${activity.values.score.basic.value.toLocaleString()}</span>
                                <span class="stat-label-small">Score</span>
                            </div>
                            ` : ''}
                        </div>
                        ` : ''}
                        
                        <div class="fireteam">
                            <div class="fireteam-title">Fireteam Members (${fireteamMembers.length}):</div>
                            <div class="fireteam-members">
                                ${Array.isArray(fireteamMembers) ? 
                                    fireteamMembers.slice(0, 6).map(member => 
                                        `<div class="member-tag ${member.isClanMember ? 'clan-member' : ''}">${member.name || member}</div>`
                                    ).join('') + (fireteamMembers.length > 6 ? '<div class="member-tag">+' + (fireteamMembers.length - 6) + ' more</div>' : '')
                                    : `<div class="member-tag clan-member">${fireteamMembers}</div>`
                                }
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = activityHTML;
        }

        function loadMoreActivities() {
            const startIndex = currentPage * CONFIG.ACTIVITIES_PER_PAGE;
            const endIndex = startIndex + CONFIG.ACTIVITIES_PER_PAGE;
            const newActivities = allActivities.slice(startIndex, endIndex);
            
            displayedActivities = [...displayedActivities, ...newActivities];
            currentPage++;
            
            renderActivities(displayedActivities);
            updateActivityControls();
        }

        function openActivityDetails(instanceId) {
            const url = `activity-details.html?instanceId=${instanceId}`;
            window.open(url, '_blank');
        }

        async function collectRecentActivities() {
            const allRecentActivities = [];
            const activityPromises = [];
            const cutoffDate = new Date(Date.now() - (CONFIG.HOURS_LOOKBACK * 60 * 60 * 1000));

            for (const member of clanMembers) {
                const membershipType = member.destinyUserInfo.membershipType;
                const membershipId = member.destinyUserInfo.membershipId;
                
                try {
                    const profileEndpoint = `/Destiny2/${membershipType}/Profile/${membershipId}/?components=200`;
                    const profile = await makeAPIRequest(profileEndpoint);
                    
                    if (profile && profile.characters && profile.characters.data) {
                        const characters = Object.keys(profile.characters.data);
                        
                        for (const characterId of characters.slice(0, 3)) {
                            activityPromises.push(
                                getActivityHistory(membershipType, membershipId, characterId, 25)
                                    .then(activities => 
                                        activities
                                            .filter(activity => isWithinLast24Hours(activity.period))
                                            .map(activity => ({
                                                ...activity,
                                                memberInfo: {
                                                    displayName: member.destinyUserInfo.displayName,
                                                    membershipType: membershipType,
                                                    membershipId: membershipId,
                                                    characterId: characterId
                                                }
                                            }))
                                    )
                            );
                        }
                    }
                } catch (error) {
                    if (error.message.includes('private') || error.message.includes('No peeking')) {
                        console.log(`Profile is private for member ${member.destinyUserInfo.displayName}, skipping...`);
                    } else {
                        console.error(`Error getting profile for member ${member.destinyUserInfo.displayName}:`, error);
                    }
                }
            }

            const activityResults = await Promise.allSettled(activityPromises);
            
            activityResults.forEach(result => {
                if (result.status === 'fulfilled' && result.value) {
                    allRecentActivities.push(...result.value);
                }
            });

            // Remove duplicates based on instanceId and sort by date
            const uniqueActivities = allRecentActivities.reduce((acc, activity) => {
                const key = activity.activityDetails.instanceId;
                if (!acc.has(key)) {
                    acc.set(key, activity);
                }
                return acc;
            }, new Map());

            const sortedActivities = Array.from(uniqueActivities.values())
                .sort((a, b) => new Date(b.period) - new Date(a.period));
            
            console.log(`Collected ${sortedActivities.length} activities from ${clanMembers.length} clan members`);
            return sortedActivities;
        }

        async function init() {
            try {
                console.log('Getting clan information...');
                clanData = await getClanByName();
                
                if (!clanData || !clanData.detail) {
                    throw new Error('Clan not found');
                }

                console.log('Getting clan members...');
                clanMembers = await getClanMembers(clanData.detail.groupId);
                
                if (clanMembers.length === 0) {
                    throw new Error('No clan members found');
                }

                // Create set of clan member IDs for quick lookup
                clanMemberIds = new Set(clanMembers.map(member => member.destinyUserInfo.membershipId));

                console.log(`Found ${clanMembers.length} clan members`);

                console.log('Collecting recent activities...');
                allActivities = await collectRecentActivities();
                
                console.log(`Found ${allActivities.length} activities in last ${CONFIG.HOURS_LOOKBACK} hours`);

                hideLoading();
                showContent();
                
                updateStatsBar();
                loadMoreActivities();

                // Set up load more button
                document.getElementById('loadMoreBtn').addEventListener('click', loadMoreActivities);

            } catch (error) {
                console.error('Initialization failed:', error);
                showError(`Failed to load clan data: ${error.message}`);
            }
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>