<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player Stats Debug - Destiny 2 Clan Tracker</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f1419 0%, #1a1a2e 50%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 2000px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #f7931e;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .debug-section {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid #444;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .debug-title {
            color: #f7931e;
            font-size: 1.3em;
            margin-bottom: 15px;
        }

        .debug-input {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .debug-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #555;
            border-radius: 5px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 1em;
        }

        .debug-input button {
            padding: 10px 20px;
            background: #f7931e;
            color: #000;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s ease;
        }

        .debug-input button:hover {
            background: #ff6600;
        }

        .loading-message {
            text-align: center;
            color: #f7931e;
            font-size: 1.2em;
            margin: 20px 0;
            display: none;
        }

        .activity-title {
            font-size: 2em;
            color: #f7931e;
            margin-bottom: 10px;
        }

        .activity-subtitle {
            color: #aaa;
            font-size: 1.1em;
            margin-bottom: 20px;
        }

        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .overview-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
        }

        .overview-label {
            color: #888;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .overview-value {
            color: #fff;
            font-size: 1.2em;
            font-weight: bold;
        }

        .team-summary {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid #444;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .team-title {
            font-size: 1.5em;
            color: #f7931e;
            margin-bottom: 15px;
        }

        .team-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }

        .team-stat {
            text-align: center;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            border: 1px solid #333;
        }

        .team-stat-value {
            display: block;
            font-size: 1.4em;
            font-weight: bold;
            color: #f7931e;
            margin-bottom: 3px;
        }

        .team-stat-label {
            display: block;
            font-size: 0.9em;
            color: #aaa;
        }

        .player-stats {
            margin-bottom: 25px;
        }

        .player-rows-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
            align-items: start;
        }

        .player-card {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid #444;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            height: 600px;
        }

        .player-card:hover {
            border-color: #f7931e;
            transform: translateY(-2px);
        }

        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
            flex-shrink: 0;
        }

        .player-emblem {
            position: relative;
            width: 240px;
            height: 54px;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #555;
            display: flex;
            align-items: center;
            background: #000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.6);
        }

        .player-emblem:hover {
            border-color: #f7931e;
            transform: scale(1.01);
        }

        .emblem-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
        }

        .emblem-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0.3) 70%, rgba(0,0,0,0.8) 100%);
        }

        .emblem-icon {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            width: 42px;
            height: 42px;
            border-radius: 3px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.8);
            object-fit: cover;
            z-index: 3;
        }

        .emblem-content {
            position: relative;
            z-index: 2;
            padding: 8px 54px 8px 12px;
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .player-name {
            color: #f7931e;
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 2px;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .player-name:hover {
            color: #ff6600;
        }

        .player-subtitle {
            color: #aaa;
            font-size: 0.9em;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        .stat-box {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #333;
            border-radius: 6px;
            padding: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #f7931e;
            margin-bottom: 2px;
        }

        .stat-label {
            color: #aaa;
            font-size: 0.7em;
        }

        .weapons-section, .additional-stats-section {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid #333;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .section-title {
            color: #f7931e;
            font-size: 0.9em;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .weapon-item, .additional-stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid #444;
            font-size: 0.8em;
        }

        .weapon-item:last-child, .additional-stat-item:last-child {
            border-bottom: none;
        }

        .weapon-name, .stat-name {
            color: #ccc;
        }

        .weapon-kills, .stat-value-small {
            color: #fff;
            font-weight: bold;
        }

        /* Popup Styles */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: flex-start;
            z-index: 1000;
            padding-top: 50px;
        }

        .popup-content {
            background: rgba(20, 20, 20, 0.98);
            border: 2px solid #f7931e;
            border-radius: 12px;
            padding: 25px;
            max-width: 1400px;
            width: 90%;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
            position: relative;
        }

        .popup-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }

        .popup-emblem {
            position: relative;
            width: 240px;
            height: 54px;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #555;
            display: flex;
            align-items: center;
            background: #000;
            margin-right: 20px;
        }

        .popup-emblem .emblem-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .popup-emblem .emblem-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0.3) 70%, rgba(0,0,0,0.8) 100%);
        }

        .popup-emblem .emblem-icon {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            width: 42px;
            height: 42px;
            border-radius: 3px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            object-fit: cover;
            z-index: 3;
        }

        .popup-emblem .emblem-content {
            position: relative;
            z-index: 2;
            padding: 8px 54px 8px 12px;
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        .popup-player-name {
            color: #f7931e;
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 2px;
        }

        .popup-player-subtitle {
            color: #aaa;
            font-size: 0.9em;
        }

        .build-grid {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        .abilities-section {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
        }

        .ability-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding: 6px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 4px;
            border: 1px solid #444;
        }

        .ability-icon {
            width: 32px;
            height: 32px;
            margin-right: 10px;
            border-radius: 4px;
            border: 1px solid #555;
        }

        .ability-name {
            color: #fff;
            font-size: 0.9em;
        }

        .aspects-fragments-section {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
        }

        .aspects-row, .fragments-row, .artifact-mods-row {
            margin-bottom: 20px;
        }

        .aspects-grid, .fragments-grid, .artifact-mods-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 10px;
        }

        .aspect-item, .fragment-item, .artifact-mod-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid #444;
            border-radius: 6px;
            text-align: center;
        }

        .aspect-icon, .fragment-icon, .artifact-mod-icon {
            width: 48px;
            height: 48px;
            border-radius: 4px;
            border: 1px solid #555;
            margin-bottom: 5px;
        }

        .aspect-name, .fragment-name, .artifact-mod-name {
            color: #fff;
            font-size: 0.8em;
            line-height: 1.2;
        }

        .stats-section {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
        }

        .stats-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid #444;
            border-radius: 4px;
        }

        .stat-name {
            color: #aaa;
            font-size: 0.9em;
        }

        .stat-value {
            color: #fff;
            font-weight: bold;
        }

        .stat-total {
            border-top: 1px solid #555;
            margin-top: 10px;
            padding-top: 10px;
            font-weight: bold;
            color: #f7931e;
        }

        .armor-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .armor-piece {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .armor-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 10px;
            border-radius: 6px;
            border: 1px solid #555;
        }

        .armor-name {
            color: #fff;
            font-size: 0.9em;
            margin-bottom: 8px;
            line-height: 1.2;
        }

        .armor-type {
            color: #888;
            font-size: 0.8em;
            margin-bottom: 10px;
        }

        .armor-mods {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            justify-content: center;
        }

        .armor-mod {
            display: flex;
            align-items: center;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid #555;
            border-radius: 3px;
            padding: 2px 4px;
        }

        .armor-mod-icon {
            width: 16px;
            height: 16px;
            margin-right: 4px;
            border-radius: 2px;
        }

        .armor-mod-name {
            color: #ccc;
            font-size: 0.7em;
            white-space: nowrap;
        }

        @media (max-width: 1200px) {
            .player-rows-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 800px) {
            .player-rows-container {
                grid-template-columns: 1fr;
            }
            
            .build-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Player Stats Debug</h1>
        
        <div class="debug-section">
            <div class="debug-title">Load Activity Data</div>
            <div class="debug-input">
                <input type="text" id="instanceId" placeholder="Enter Instance ID (e.g., 12345678901234567890)" />
                <button onclick="loadActivity()">Load Activity</button>
            </div>
            <div class="loading-message" id="loadingMessage">Loading activity data...</div>
        </div>

        <div id="activityDetails"></div>
        <div id="playerStats"></div>
    </div>

    <!-- Build Popup -->
    <div id="buildPopup" class="popup-overlay">
        <div class="popup-content">
            <!-- Popup content will be populated by JavaScript -->
        </div>
    </div>

    <script>
        let lastActivityData = null;
        let isPopupVisible = false;
        let isMouseOverPopup = false;
        let isMouseOverCard = false;
        let cachedBuildData = {};

        function showLoadingMessage() {
            document.getElementById('loadingMessage').style.display = 'block';
        }

        function hideLoadingMessage() {
            document.getElementById('loadingMessage').style.display = 'none';
        }

        async function loadActivity() {
            const instanceId = document.getElementById('instanceId').value.trim();
            
            if (!instanceId) {
                alert('Please enter a valid instance ID');
                return;
            }
            
            try {
                showLoadingMessage();
                
                const response = await fetch(`https://www.bungie.net/Platform/Destiny2/Stats/PostGameCarnageReport/${instanceId}/`, {
                    headers: {
                        'X-API-Key': '47c0c5d86d214ef5861f3d693bb00b6e'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                lastActivityData = data;
                
                // Pre-cache build data for all players
                cachedBuildData = {};
                data.Response.entries.forEach((player, index) => {
                    const playerName = player.player.destinyUserInfo.bungieGlobalDisplayName || `Player ${index + 1}`;
                    cachedBuildData[index] = generateMockBuildData(playerName);
                });
                
                hideLoadingMessage();
                renderActivityDetails(data);
                renderPlayerStats(data);
                
            } catch (error) {
                hideLoadingMessage();
                console.error('Error loading activity:', error);
                document.getElementById('playerStats').innerHTML = `
                    <div style="color: red; text-align: center; padding: 20px;">
                        Failed to load activity: ${error.message}
                    </div>
                `;
            }
        }

        function renderActivityDetails(data) {
            const activity = data.Response.activityDetails;
            const period = new Date(data.Response.period).toLocaleString();
            
            document.getElementById('activityDetails').innerHTML = `
                <div class="activity-title">${getActivityName(activity.directorActivityHash)}</div>
                <div class="activity-subtitle">Completed ${period}</div>
                
                <div class="overview-grid">
                    <div class="overview-item">
                        <div class="overview-label">Duration</div>
                        <div class="overview-value">${formatDuration(data.Response.activityDurationSeconds)}</div>
                    </div>
                    <div class="overview-item">
                        <div class="overview-label">Players</div>
                        <div class="overview-value">${data.Response.entries.length}</div>
                    </div>
                    <div class="overview-item">
                        <div class="overview-label">Activity Mode</div>
                        <div class="overview-value">${getActivityMode(activity.mode)}</div>
                    </div>
                    <div class="overview-item">
                        <div class="overview-label">Instance ID</div>
                        <div class="overview-value">${data.Response.activityDetails.instanceId}</div>
                    </div>
                </div>
                
                <div class="team-summary">
                    <div class="team-title">Team Performance</div>
                    <div class="team-stats-grid">
                        <div class="team-stat">
                            <span class="team-stat-value">${calculateTeamStat(data, 'kills')}</span>
                            <span class="team-stat-label">Total Kills</span>
                        </div>
                        <div class="team-stat">
                            <span class="team-stat-value">${calculateTeamStat(data, 'deaths')}</span>
                            <span class="team-stat-label">Total Deaths</span>
                        </div>
                        <div class="team-stat">
                            <span class="team-stat-value">${calculateTeamStat(data, 'assists')}</span>
                            <span class="team-stat-label">Total Assists</span>
                        </div>
                        <div class="team-stat">
                            <span class="team-stat-value">${calculateTeamStat(data, 'precisionKills')}</span>
                            <span class="team-stat-label">Precision Kills</span>
                        </div>
                        <div class="team-stat">
                            <span class="team-stat-value">${isRaid(activity.mode) ? 'N/A' : calculateTeamStat(data, 'score')}</span>
                            <span class="team-stat-label">Total Score</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPlayerStats(data) {
            const container = document.getElementById('playerStats');
            container.innerHTML = '<div class="player-stats"><h2 style="color: #f7931e; margin-bottom: 20px;">Individual Player Performance</h2><div class="player-rows-container"></div></div>';
            
            const playersContainer = container.querySelector('.player-rows-container');
            
            data.Response.entries.forEach((player, i) => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player-card';
                
                const emblemBackground = `https://www.bungie.net${player.player.emblemBackgroundPath}`;
                const emblemIcon = `https://www.bungie.net${player.player.emblemPath}`;
                
                playerDiv.innerHTML = `
                    <div class="player-header">
                        <div class="player-emblem">
                            <img src="${emblemBackground}" alt="Emblem" class="emblem-background" onerror="this.src='https://via.placeholder.com/240x54/333/fff?text=No+Emblem'">
                            <div class="emblem-overlay"></div>
                            <img src="${emblemIcon}" alt="Emblem Icon" class="emblem-icon" onerror="this.src='https://via.placeholder.com/42x42/333/fff?text=?'">
                            <div class="emblem-content">
                                <div class="player-name">${player.player.destinyUserInfo.bungieGlobalDisplayName || `Player ${i + 1}`}</div>
                                <div class="player-subtitle">${player.player.lightLevel || 'N/A'} Light • ${player.player.characterLevel || 'N/A'} Level</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-grid">
                        <div class="stat-box">
                            <div class="stat-value">${getStatValue(player, 'kills')}</div>
                            <div class="stat-label">Kills</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${getStatValue(player, 'deaths')}</div>
                            <div class="stat-label">Deaths</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${getStatValue(player, 'assists')}</div>
                            <div class="stat-label">Assists</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${getStatValue(player, 'precisionKills')}</div>
                            <div class="stat-label">Precision</div>
                        </div>
                    </div>
                    
                    <div class="weapons-section">
                        <div class="section-title">Weapons</div>
                        ${renderWeapons(player)}
                    </div>
                    
                    <div class="additional-stats-section">
                        <div class="section-title">Additional Stats</div>
                        ${renderAdditionalStats(player, data.Response.activityDetails.mode)}
                    </div>
                `;
                
                // Add hover event listener only to the player name (with timeout to ensure DOM is ready)
                setTimeout(() => {
                    const playerNameElement = playerDiv.querySelector('.player-name');
                    if (playerNameElement) {
                        playerNameElement.addEventListener('mouseenter', function() {
                            showBuildPopup({
                                name: player.player.destinyUserInfo.bungieGlobalDisplayName || `Player ${i + 1}`,
                                class: getRandomClass()
                            }, i);
                        });

                        playerNameElement.addEventListener('mouseleave', function() {
                            // Only hide if not hovering over popup
                            setTimeout(() => {
                                if (!isMouseOverPopup && !isMouseOverCard) {
                                    hideBuildPopup();
                                }
                            }, 100);
                        });
                    }
                }, 0);
                
                playersContainer.appendChild(playerDiv);
            });
        }

        function showBuildPopup(playerData, playerIndex) {
            const popup = document.getElementById('buildPopup');
            const content = popup.querySelector('.popup-content');
            
            // Get real player data from the activity
            const realPlayerData = lastActivityData.Response.entries[playerIndex];
            const emblemBackground = `https://www.bungie.net${realPlayerData.player.emblemBackgroundPath}`;
            const emblemIcon = `https://www.bungie.net${realPlayerData.player.emblemPath}`;
            const playerName = realPlayerData.player.destinyUserInfo.bungieGlobalDisplayName;
            const lightLevel = realPlayerData.player.lightLevel || 'N/A';
            const characterLevel = realPlayerData.player.characterLevel || 'N/A';
            
            // Generate mock build data for this player (using cached data)
            const buildData = cachedBuildData[playerIndex] || generateMockBuildData(playerName);
            
            content.innerHTML = `
                <div class="popup-header">
                    <div class="popup-emblem">
                        <img src="${emblemBackground}" alt="Emblem" class="emblem-background" onerror="this.src='https://via.placeholder.com/240x54/333/fff?text=No+Emblem'">
                        <div class="emblem-overlay"></div>
                        <img src="${emblemIcon}" alt="Emblem Icon" class="emblem-icon" onerror="this.src='https://via.placeholder.com/42x42/333/fff?text=?'">
                        <div class="emblem-content">
                            <div class="popup-player-name">${playerName}</div>
                            <div class="popup-player-subtitle">${lightLevel} Light • ${characterLevel} Level</div>
                        </div>
                    </div>
                </div>
                
                <div class="build-grid">
                    <div class="abilities-section">
                        <div class="section-title">Abilities</div>
                        <div class="ability-item">
                            <img src="${buildData.super.icon}" class="ability-icon" alt="Super" onerror="this.src='https://via.placeholder.com/32x32/333/fff?text=S'">
                            <span class="ability-name">${buildData.super.name}</span>
                        </div>
                        <div class="ability-item">
                            <img src="${buildData.grenade.icon}" class="ability-icon" alt="Grenade" onerror="this.src='https://via.placeholder.com/32x32/333/fff?text=G'">
                            <span class="ability-name">${buildData.grenade.name}</span>
                        </div>
                        <div class="ability-item">
                            <img src="${buildData.melee.icon}" class="ability-icon" alt="Melee" onerror="this.src='https://via.placeholder.com/32x32/333/fff?text=M'">
                            <span class="ability-name">${buildData.melee.name}</span>
                        </div>
                        <div class="ability-item">
                            <img src="${buildData.classAbility.icon}" class="ability-icon" alt="Class Ability" onerror="this.src='https://via.placeholder.com/32x32/333/fff?text=C'">
                            <span class="ability-name">${buildData.classAbility.name}</span>
                        </div>
                        <div class="ability-item">
                            <img src="${buildData.movement.icon}" class="ability-icon" alt="Movement" onerror="this.src='https://via.placeholder.com/32x32/333/fff?text=J'">
                            <span class="ability-name">${buildData.movement.name}</span>
                        </div>
                    </div>
                    
                    <div class="aspects-fragments-section">
                        <div class="aspects-row">
                            <div class="section-title">Aspects</div>
                            <div class="aspects-grid">
                                ${buildData.aspects.map(aspect => `
                                    <div class="aspect-item">
                                        <img src="${aspect.icon}" class="aspect-icon" alt="${aspect.name}" onerror="this.src='https://via.placeholder.com/48x48/333/fff?text=A'">
                                        <div class="aspect-name">${aspect.name}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="fragments-row">
                            <div class="section-title">Fragments</div>
                            <div class="fragments-grid">
                                ${buildData.fragments.map(fragment => `
                                    <div class="fragment-item">
                                        <img src="${fragment.icon}" class="fragment-icon" alt="${fragment.name}" onerror="this.src='https://via.placeholder.com/48x48/333/fff?text=F'">
                                        <div class="fragment-name">${fragment.name}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="artifact-mods-row">
                            <div class="section-title">Artifact Mods</div>
                            <div class="artifact-mods-grid">
                                ${buildData.artifactMods.map(mod => `
                                    <div class="artifact-mod-item">
                                        <img src="${mod.icon}" class="artifact-mod-icon" alt="${mod.name}" onerror="this.src='https://via.placeholder.com/48x48/333/fff?text=AM'">
                                        ${mod.name.length > 15 ? '' : `<div class="artifact-mod-name">${mod.name}</div>`}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <div class="stats-section">
                        <div class="section-title">Stats</div>
                        <div class="stats-list">
                            <div class="stat-item">
                                <span class="stat-name">Mobility</span>
                                <span class="stat-value">${buildData.stats.mobility}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-name">Resilience</span>
                                <span class="stat-value">${buildData.stats.resilience}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-name">Recovery</span>
                                <span class="stat-value">${buildData.stats.recovery}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-name">Discipline</span>
                                <span class="stat-value">${buildData.stats.discipline}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-name">Intellect</span>
                                <span class="stat-value">${buildData.stats.intellect}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-name">Strength</span>
                                <span class="stat-value">${buildData.stats.strength}</span>
                            </div>
                            <div class="stat-item stat-total">
                                <span class="stat-name">Total</span>
                                <span class="stat-value">${buildData.stats.total}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="armor-grid">
                    ${buildData.armor.map(piece => `
                        <div class="armor-piece">
                            <img src="${piece.icon}" class="armor-icon" alt="${piece.name}" onerror="this.src='https://via.placeholder.com/64x64/333/fff?text=${piece.type.charAt(0)}'">
                            <div class="armor-name">${piece.name}</div>
                            <div class="armor-type">${piece.type}</div>
                            <div class="armor-mods">
                                ${piece.mods.map(mod => `
                                    <div class="armor-mod">
                                        <img src="${mod.icon}" class="armor-mod-icon" alt="${mod.name}" onerror="this.src='https://via.placeholder.com/16x16/333/fff?text=M'">
                                        <span class="armor-mod-name">${mod.name}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            popup.style.display = 'flex';
            isPopupVisible = true;
        }

        function hideBuildPopup() {
            document.getElementById('buildPopup').style.display = 'none';
            isPopupVisible = false;
        }

        function generateMockBuildData(playerName) {
            // Use player name to generate consistent data
            const hash = playerName.split('').reduce((a, b) => {
                a = ((a << 5) - a) + b.charCodeAt(0);
                return a & a;
            }, 0);
            
            const random = (max) => Math.abs(hash * (max + 1)) % max;
            const classes = ['Hunter', 'Titan', 'Warlock'];
            const playerClass = classes[Math.abs(hash) % classes.length];
            
            // Bungie API icon base URLs
            const iconBase = 'https://www.bungie.net/common/destiny2_content/icons/';
            
            // Mock subclass data based on class
            const subclassData = {
                'Hunter': {
                    supers: [
                        { name: 'Shadowshot', icon: iconBase + 'supers/super_nightstalker.png' },
                        { name: 'Golden Gun', icon: iconBase + 'supers/super_gunslinger.png' },
                        { name: 'Arc Staff', icon: iconBase + 'supers/super_arcstrider.png' }
                    ],
                    grenades: [
                        { name: 'Voidwall Grenade', icon: iconBase + 'grenades/grenade_voidwall.png' },
                        { name: 'Tripmine Grenade', icon: iconBase + 'grenades/grenade_tripmine.png' },
                        { name: 'Arcbolt Grenade', icon: iconBase + 'grenades/grenade_arcbolt.png' }
                    ],
                    melees: [
                        { name: 'Smoke Bomb', icon: iconBase + 'abilities/ability_nightstalker_smoke.png' },
                        { name: 'Throwing Knife', icon: iconBase + 'abilities/ability_gunslinger_knife.png' },
                        { name: 'Combination Blow', icon: iconBase + 'abilities/ability_arcstrider_punch.png' }
                    ],
                    classAbilities: [
                        { name: 'Marksman\'s Dodge', icon: iconBase + 'abilities/ability_hunter_dodge_marksman.png' },
                        { name: 'Gambler\'s Dodge', icon: iconBase + 'abilities/ability_hunter_dodge_gambler.png' }
                    ],
                    movement: [
                        { name: 'High Jump', icon: iconBase + 'abilities/ability_hunter_jump_high.png' },
                        { name: 'Strafe Jump', icon: iconBase + 'abilities/ability_hunter_jump_strafe.png' },
                        { name: 'Triple Jump', icon: iconBase + 'abilities/ability_hunter_jump_triple.png' }
                    ]
                },
                'Titan': {
                    supers: [
                        { name: 'Ward of Dawn', icon: iconBase + 'supers/super_sentinel.png' },
                        { name: 'Hammer of Sol', icon: iconBase + 'supers/super_sunbreaker.png' },
                        { name: 'Fist of Havoc', icon: iconBase + 'supers/super_striker.png' }
                    ],
                    grenades: [
                        { name: 'Magnetic Grenade', icon: iconBase + 'grenades/grenade_magnetic.png' },
                        { name: 'Thermite Grenade', icon: iconBase + 'grenades/grenade_thermite.png' },
                        { name: 'Flashbang Grenade', icon: iconBase + 'grenades/grenade_flashbang.png' }
                    ],
                    melees: [
                        { name: 'Shield Bash', icon: iconBase + 'abilities/ability_sentinel_shield.png' },
                        { name: 'Hammer Strike', icon: iconBase + 'abilities/ability_sunbreaker_hammer.png' },
                        { name: 'Seismic Strike', icon: iconBase + 'abilities/ability_striker_shoulder.png' }
                    ],
                    classAbilities: [
                        { name: 'Towering Barricade', icon: iconBase + 'abilities/ability_titan_barricade_large.png' },
                        { name: 'Rally Barricade', icon: iconBase + 'abilities/ability_titan_barricade_small.png' }
                    ],
                    movement: [
                        { name: 'High Lift', icon: iconBase + 'abilities/ability_titan_jump_high.png' },
                        { name: 'Strafe Lift', icon: iconBase + 'abilities/ability_titan_jump_strafe.png' },
                        { name: 'Catapult Lift', icon: iconBase + 'abilities/ability_titan_jump_catapult.png' }
                    ]
                },
                'Warlock': {
                    supers: [
                        { name: 'Nova Bomb', icon: iconBase + 'supers/super_voidwalker.png' },
                        { name: 'Daybreak', icon: iconBase + 'supers/super_dawnblade.png' },
                        { name: 'Chaos Reach', icon: iconBase + 'supers/super_stormcaller.png' }
                    ],
                    grenades: [
                        { name: 'Vortex Grenade', icon: iconBase + 'grenades/grenade_vortex.png' },
                        { name: 'Solar Grenade', icon: iconBase + 'grenades/grenade_solar.png' },
                        { name: 'Storm Grenade', icon: iconBase + 'grenades/grenade_storm.png' }
                    ],
                    melees: [
                        { name: 'Atomic Breach', icon: iconBase + 'abilities/ability_voidwalker_melee.png' },
                        { name: 'Celestial Fire', icon: iconBase + 'abilities/ability_dawnblade_melee.png' },
                        { name: 'Chain Lightning', icon: iconBase + 'abilities/ability_stormcaller_melee.png' }
                    ],
                    classAbilities: [
                        { name: 'Healing Rift', icon: iconBase + 'abilities/ability_warlock_rift_healing.png' },
                        { name: 'Empowering Rift', icon: iconBase + 'abilities/ability_warlock_rift_empowering.png' }
                    ],
                    movement: [
                        { name: 'Glide', icon: iconBase + 'abilities/ability_warlock_jump_glide.png' },
                        { name: 'Burst Glide', icon: iconBase + 'abilities/ability_warlock_jump_burst.png' },
                        { name: 'Strafe Glide', icon: iconBase + 'abilities/ability_warlock_jump_strafe.png' }
                    ]
                }
            };
            
            const classData = subclassData[playerClass];
            
            // Generate aspects and fragments
            const aspects = [
                { name: 'Vanishing Step', icon: iconBase + 'aspects/aspect_void_1.png' },
                { name: 'Stylish Executioner', icon: iconBase + 'aspects/aspect_void_2.png' }
            ];
            
            const fragments = [
                { name: 'Echo of Starvation', icon: iconBase + 'fragments/fragment_void_1.png' },
                { name: 'Echo of Instability', icon: iconBase + 'fragments/fragment_void_2.png' },
                { name: 'Echo of Remnants', icon: iconBase + 'fragments/fragment_void_3.png' },
                { name: 'Echo of Leeching', icon: iconBase + 'fragments/fragment_void_4.png' }
            ];
            
            // Generate artifact mods
            const artifactMods = [
                { name: 'Surge Detonators', icon: iconBase + 'mods/artifact_mod_1.png' },
                { name: 'Overload Auto Rifle', icon: iconBase + 'mods/artifact_mod_2.png' },
                { name: 'Anti-Barrier Scout Rifle', icon: iconBase + 'mods/artifact_mod_3.png' },
                { name: 'Unstoppable Hand Cannon', icon: iconBase + 'mods/artifact_mod_4.png' }
            ].slice(0, 3 + random(2)); // 3-4 artifact mods
            
            // Generate armor with mods
            const armorTypes = ['Helmet', 'Gauntlets', 'Chest Armor', 'Leg Armor', 'Class Item'];
            const armor = armorTypes.map((type, index) => {
                const armorMods = [
                    { name: 'Powerful Friends', icon: iconBase + 'mods/mod_charged_with_light.png' },
                    { name: 'Radiant Light', icon: iconBase + 'mods/mod_charged_with_light_2.png' },
                    { name: 'Taking Charge', icon: iconBase + 'mods/mod_charged_with_light_3.png' },
                    { name: 'High Energy Fire', icon: iconBase + 'mods/mod_charged_with_light_4.png' },
                    { name: 'Elemental Charge', icon: iconBase + 'mods/mod_elemental.png' }
                ].slice(0, 1 + random(3)); // 1-3 mods per piece
                
                return {
                    name: `${playerClass} ${type}`,
                    type: type,
                    icon: iconBase + `armor/${playerClass.toLowerCase()}_${type.toLowerCase().replace(' ', '_')}.png`,
                    mods: armorMods
                };
            });
            
            // Generate stats
            const baseStats = [60, 70, 80, 90, 100];
            const stats = {
                mobility: baseStats[random(baseStats.length)],
                resilience: baseStats[random(baseStats.length)],
                recovery: baseStats[random(baseStats.length)],
                discipline: baseStats[random(baseStats.length)],
                intellect: baseStats[random(baseStats.length)],
                strength: baseStats[random(baseStats.length)]
            };
            stats.total = stats.mobility + stats.resilience + stats.recovery + stats.discipline + stats.intellect + stats.strength;
            
            return {
                class: playerClass,
                super: classData.supers[random(classData.supers.length)],
                grenade: classData.grenades[random(classData.grenades.length)],
                melee: classData.melees[random(classData.melees.length)],
                classAbility: classData.classAbilities[random(classData.classAbilities.length)],
                movement: classData.movement[random(classData.movement.length)],
                aspects: aspects,
                fragments: fragments,
                artifactMods: artifactMods,
                armor: armor,
                stats: stats
            };
        }

        function getRandomClass() {
            const classes = ['Hunter', 'Titan', 'Warlock'];
            return classes[Math.floor(Math.random() * classes.length)];
        }

        // Helper functions
        function getActivityName(hash) {
            const activityNames = {
                '1441982566': 'Deep Stone Crypt',
                '3458480158': 'Garden of Salvation',
                '2659723068': 'Vault of Glass',
                '1441982566': 'King\'s Fall',
                '4217492330': 'Root of Nightmares'
            };
            return activityNames[hash] || 'Unknown Activity';
        }

        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours}h ${minutes}m ${secs}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${secs}s`;
            } else {
                return `${secs}s`;
            }
        }

        function getActivityMode(mode) {
            const modes = {
                '4': 'Raid',
                '16': 'Nightfall',
                '18': 'Strike',
                '19': 'Iron Banner',
                '25': 'Mayhem',
                '31': 'Supremacy',
                '32': 'Private Match',
                '37': 'Survival',
                '38': 'Countdown',
                '41': 'Trials of Osiris',
                '43': 'Iron Banner Control',
                '44': 'Iron Banner Clash',
                '45': 'Iron Banner Supremacy',
                '48': 'Rumble',
                '59': 'Showdown',
                '60': 'Lockdown',
                '61': 'Scorched',
                '62': 'Scorched Team',
                '65': 'Elimination',
                '67': 'Momentum Control',
                '68': 'Breakthrough',
                '69': 'Clash',
                '70': 'Control',
                '71': 'Gambit',
                '73': 'Gambit Prime',
                '75': 'Reckoning',
                '76': 'Menagerie',
                '77': 'Vex Offensive',
                '78': 'Nightmare Hunt',
                '79': 'Elimination',
                '80': 'Momentum',
                '81': 'Dungeon',
                '82': 'Sundial',
                '83': 'Trials of Osiris',
                '84': 'Dares of Eternity'
            };
            return modes[mode] || 'Unknown Mode';
        }

        function calculateTeamStat(data, statName) {
            return data.Response.entries.reduce((total, player) => {
                return total + getStatValue(player, statName);
            }, 0);
        }

        function isRaid(mode) {
            return mode === 4;
        }

        function getStatValue(player, statName) {
            const basicStats = player.values[statName];
            if (basicStats) {
                return basicStats.basic.value;
            }
            
            const extendedStats = player.extended?.values[statName];
            if (extendedStats) {
                return extendedStats.basic.value;
            }
            
            return 0;
        }

        function renderWeapons(player) {
            const weapons = player.extended?.weapons || [];
            if (weapons.length === 0) {
                return '<div style="color: #888; font-style: italic;">No weapon data available</div>';
            }
            
            return weapons.map(weapon => `
                <div class="weapon-item">
                    <span class="weapon-name">Weapon ${weapon.referenceId}</span>
                    <span class="weapon-kills">${weapon.values.uniqueWeaponKills?.basic?.value || 0}</span>
                </div>
            `).join('');
        }

        function renderAdditionalStats(player, activityMode) {
            const isRaidActivity = isRaid(activityMode);
            const stats = [
                { name: 'Super Kills', key: 'weaponKillsSuper' },
                { name: 'Grenade Kills', key: 'weaponKillsGrenade' },
                { name: 'Melee Kills', key: 'weaponKillsMelee' },
                { name: 'Ability Kills', key: 'weaponKillsAbility' },
                { name: 'Score', key: 'score', hideInRaid: true }
            ];
            
            return stats
                .filter(stat => !(stat.hideInRaid && isRaidActivity))
                .map(stat => {
                    const value = isRaidActivity && stat.key === 'score' ? 'N/A' : getStatValue(player, stat.key);
                    return `
                        <div class="additional-stat-item">
                            <span class="stat-name">${stat.name}</span>
                            <span class="stat-value-small">${value}</span>
                        </div>
                    `;
                }).join('');
        }

        // Popup event handlers
        document.getElementById('buildPopup').addEventListener('click', function(e) {
            if (e.target === this) {
                hideBuildPopup();
            }
        });

        document.getElementById('buildPopup').addEventListener('mouseenter', function() {
            isMouseOverPopup = true;
        });

        document.getElementById('buildPopup').addEventListener('mouseleave', function() {
            isMouseOverPopup = false;
            setTimeout(() => {
                if (!isMouseOverCard) {
                    hideBuildPopup();
                }
            }, 100);
        });
    </script>
</body>
</html>